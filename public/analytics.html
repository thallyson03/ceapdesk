<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Produtividade</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .stats-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .stats-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .stats-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .productivity-table {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .productivity-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .productivity-table tbody tr:hover {
            background-color: #f8f9fa;
            transform: scale(1.01);
            transition: all 0.2s ease;
        }
        .filter-card {
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: none;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-0 text-primary">
                    <i class="fas fa-chart-line me-2"></i>Painel de Produtividade
                </h1>
                <p class="text-muted mb-0">Análise de performance e métricas</p>
            </div>
            <div class="d-flex align-items-center gap-2">
                <a href="/dashboard.html" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Dashboard
                </a>
                <button id="download-productivity-btn" class="btn btn-primary d-none">
                    <i class="fas fa-download me-1"></i>Baixar Relatório
                </button>
                <span id="user-info" class="me-2 fw-bold"></span>
                <button id="logout-btn" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt me-1"></i>Sair
                </button>
            </div>
        </div>

        <!-- Cards de Métricas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card success text-center p-3">
                    <div class="metric-value" id="total-tickets">0</div>
                    <div class="metric-label">Tickets Abertos</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card warning text-center p-3">
                    <div class="metric-value" id="tickets-fechados">0</div>
                    <div class="metric-label">Tickets Fechados</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card info text-center p-3">
                    <div class="metric-value" id="taxa-resolucao">0%</div>
                    <div class="metric-label">Taxa de Resolução</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card text-center p-3">
                    <div class="metric-value" id="usuarios-ativos">0</div>
                    <div class="metric-label">Usuários Ativos</div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card filter-card mb-4">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0 text-primary">
                    <i class="fas fa-filter me-2"></i>Filtros
                </h5>
            </div>
            <div class="card-body">
                <form id="productivity-form" class="row g-3">
                    <div class="col-md-4">
                        <label for="usuario-responsavel-filtro" class="form-label fw-bold">Usuário Responsável</label>
                        <select class="form-select" id="usuario-responsavel-filtro">
                            <option value="">Todos os Usuários</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="start-date-filtro" class="form-label fw-bold">Data de Início</label>
                        <input type="date" class="form-control" id="start-date-filtro">
                    </div>
                    <div class="col-md-3">
                        <label for="end-date-filtro" class="form-label fw-bold">Data de Encerramento</label>
                        <input type="date" class="form-control" id="end-date-filtro">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-1"></i>Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabela de Produtividade -->
        <div class="card mb-4">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0 text-primary">
                    <i class="fas fa-table me-2"></i>Ranking de Produtividade
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover productivity-table mb-0">
                        <thead>
                            <tr>
                                <th class="text-center">#</th>
                                <th>Usuário Responsável</th>
                                <th class="text-center">Tickets Fechados</th>
                                <th class="text-center">Performance</th>
                            </tr>
                        </thead>
                        <tbody id="productivity-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        
        <div id="status-message" class="text-center mt-4">Carregando dados...</div>
    </div>

        <script>
        // Função para decodificar JWT token
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Erro ao decodificar token:', error);
                return null;
            }
        }

                        // Declarar todas as funções primeiro
        const fetchUsers = async () => {
            console.log('Fetching users...');
            try {
                const response = await fetch('/api/v1/analytics/users', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                console.log('Users response status:', response.status);
                
                if (!response.ok) {
                    throw new Error('Erro ao buscar a lista de usuários.');
                }
                const users = await response.json();
                console.log('Users received:', users);
                populateUserDropdown(users);
                console.log('Calling fetchProductivity...');
                fetchProductivity(); // Chama a função para buscar os dados após popular a lista
            } catch (error) {
                console.error('Erro ao buscar usuários:', error);
            }
        };

                const populateUserDropdown = (users) => {
            console.log('Populating user dropdown with:', users);
            const dropdown = document.getElementById('usuario-responsavel-filtro');
            if (!dropdown) {
                console.error('Dropdown element not found!');
                return;
            }
            
            dropdown.innerHTML = ''; // Limpar dropdown
            
            // Adicionar opção "Todos"
            const optionTodos = document.createElement('option');
            optionTodos.value = 'todos';
            optionTodos.textContent = 'Todos os usuários';
            dropdown.appendChild(optionTodos);
            
            // Adicionar usuários
            users.forEach(username => {
                const option = document.createElement('option');
                option.value = username;
                option.textContent = username;
                dropdown.appendChild(option);
            });
            console.log('Dropdown populated successfully');
        };

                const fetchProductivity = async (usuario = '', startDate = '', endDate = '') => {
            console.log('fetchProductivity called with:', { usuario, startDate, endDate });
            const tableBody = document.getElementById('productivity-table-body');
            const statusMessage = document.getElementById('status-message');
            
            if (!tableBody || !statusMessage) {
                console.error('Required elements not found:', { tableBody: !!tableBody, statusMessage: !!statusMessage });
                return;
            }
            
            tableBody.innerHTML = '';
            statusMessage.textContent = 'Carregando dados...';

            let url = new URL('/api/v1/analytics/productivity', window.location.origin);
            if (usuario && usuario !== 'todos') url.searchParams.append('usuario', usuario);
            if (startDate) url.searchParams.append('startDate', startDate);
            if (endDate) url.searchParams.append('endDate', endDate);

            console.log('Fetching productivity data from:', url.toString());
            console.log('Token:', localStorage.getItem('token'));

            try {
                const response = await fetch(url.toString(), {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (response.status === 403) {
                    statusMessage.textContent = 'Acesso negado. Você não tem permissão para visualizar este painel.';
                    return;
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error('Erro ao buscar dados de produtividade.');
                }
                
                const data = await response.json();
                console.log('Dados recebidos:', data); // Debug
                console.log('Data type:', typeof data);
                console.log('Is array:', Array.isArray(data));
                console.log('Data length:', data ? data.length : 'null/undefined');
                
                if (!Array.isArray(data)) {
                    console.log('Invalid data format, showing error message');
                    statusMessage.textContent = 'Erro no formato dos dados.';
                    
                    // Buscar estatísticas mesmo sem dados de produtividade
                    try {
                        const statsResponse = await fetch('/api/v1/analytics/stats', {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        });
                        
                        if (statsResponse.ok) {
                            const stats = await statsResponse.json();
                            document.getElementById('total-tickets').textContent = stats.ticketsAbertos;
                            document.getElementById('tickets-fechados').textContent = stats.ticketsFechados;
                            document.getElementById('usuarios-ativos').textContent = stats.usuariosAtivos;
                            document.getElementById('taxa-resolucao').textContent = stats.taxaResolucao + '%';
                        }
                    } catch (error) {
                        console.error('Erro ao buscar estatísticas:', error);
                        // Limpar métricas em caso de erro
                        document.getElementById('total-tickets').textContent = '0';
                        document.getElementById('tickets-fechados').textContent = '0';
                        document.getElementById('usuarios-ativos').textContent = '0';
                        document.getElementById('taxa-resolucao').textContent = '0%';
                    }
                    return;
                }
                
                statusMessage.textContent = '';
                
                // Buscar estatísticas gerais do sistema
                const statsResponse = await fetch('/api/v1/analytics/stats', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    
                    // Atualizar cards de métricas com dados reais
                    document.getElementById('total-tickets').textContent = stats.ticketsAbertos;
                    document.getElementById('tickets-fechados').textContent = stats.ticketsFechados;
                    document.getElementById('usuarios-ativos').textContent = stats.usuariosAtivos;
                    document.getElementById('taxa-resolucao').textContent = stats.taxaResolucao + '%';
                } else {
                    console.error('Erro ao buscar estatísticas:', statsResponse.status);
                }
                
                // Calcular métricas para o ranking
                const maxTickets = Math.max(...data.map(item => item.totalFechado || 0));
                
                console.log('Rendering table with data length:', data.length);
                // Renderizar tabela com ranking
                data.forEach((item, index) => {
                    console.log('Processing item:', item);
                    console.log('Item usuarioResponsavel:', item.usuarioResponsavel);
                    console.log('Item totalFechado:', item.totalFechado);
                    const performance = maxTickets > 0 ? Math.round(((item.totalFechado || 0) / maxTickets) * 100) : 0;
                    const performanceClass = performance >= 80 ? 'success' : performance >= 50 ? 'warning' : 'danger';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="text-center fw-bold">${index + 1}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                                    <span class="text-white fw-bold">${(item.usuarioResponsavel || 'N/A').charAt(0).toUpperCase()}</span>
                                </div>
                                ${item.usuarioResponsavel || 'Não atribuído'}
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-success fs-6">${item.totalFechado || 0}</span>
                        </td>
                        <td class="text-center">
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar bg-${performanceClass}" role="progressbar" 
                                     style="width: ${performance}%" aria-valuenow="${performance}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    ${performance}%
                                </div>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                    console.log('Row added to table');
                });
                console.log('Table rendering completed');
            } catch (error) {
                console.error('Erro ao buscar produtividade:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                statusMessage.textContent = 'Erro ao carregar dados. Tente novamente.';
                statusMessage.className = 'text-center text-danger';
            }
        };

                document.getElementById('productivity-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const usuario = document.getElementById('usuario-responsavel-filtro').value;
            const startDate = document.getElementById('start-date-filtro').value;
            const endDate = document.getElementById('end-date-filtro').value;
            fetchProductivity(usuario, startDate, endDate);
        });

        const downloadProductivityReport = async () => {
            try {
                const usuario = document.getElementById('usuario-responsavel-filtro').value;
                const startDate = document.getElementById('start-date-filtro').value;
                const endDate = document.getElementById('end-date-filtro').value;
                
                const queryParams = new URLSearchParams();
                if (usuario) queryParams.append('usuario', usuario);
                if (startDate) queryParams.append('startDate', startDate);
                if (endDate) queryParams.append('endDate', endDate);
                
                const response = await fetch(`/api/v1/reports/productivity?${queryParams.toString()}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                    return;
                }
                
                if (response.status === 403) {
                    alert('Acesso negado. Apenas administradores podem baixar relatórios.');
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Erro ao gerar relatório');
                }
                
                // Criar blob e download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `relatorio_produtividade_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
            } catch (error) {
                console.error('Erro ao baixar relatório:', error);
                alert('Erro ao baixar relatório. Tente novamente.');
            }
        };

        // Event listeners e inicialização após declarar todas as funções
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, checking authentication...');
            const token = localStorage.getItem('token');
            console.log('Token from localStorage:', token ? 'exists' : 'missing');
            
            if (!token) {
                console.log('No token found, redirecting to login');
                window.location.href = '/login.html';
                return;
            }

            const payload = parseJwt(token);
            console.log('Parsed JWT payload:', payload);
            
            if (!payload || payload.role !== 'admin') {
                console.log('Access denied, not admin');
                document.body.innerHTML = '<div class="alert alert-danger text-center m-5">Acesso negado. Apenas administradores podem acessar esta página.</div>';
                return;
            }

            const userInfo = document.getElementById('user-info');
            userInfo.innerHTML = `<i class="fas fa-user me-1"></i>Olá, ${payload.username}!`;
            
            // Mostrar botão de download apenas para admins
            if (payload.role === 'admin') {
                document.getElementById('download-productivity-btn').classList.remove('d-none');
            }
            
            fetchUsers();
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        });
        
        // Event listener para download de relatório de produtividade
        document.getElementById('download-productivity-btn').addEventListener('click', downloadProductivityReport);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>